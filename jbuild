#!/usr/bin/env bash

todayDate='\D{%Y.%m.%d}'

# Build variables
WORKING="working"
OUTPUT="output"
SOURCE="archlive"
LIVEROOT="airootfs"
CONFIG="jovarkos-config"

function error() {

    printf "$*\n" >&2
}

function error_no-archiso() {

   if [[ ! -d "${SOURCE}" ]]; then

cat << MENU
Please select profile to build upon:
    releng (Used in Official Monthly Builds)
    baseline (Minimal live configuration)
MENU
        read -r -p "Profile: " PROFILE

        cp -r "/usr/share/archiso/configs/${PROFILE}" ${SOURCE}

        echo "Copied profile ${PROFILE} to ${SOURCE}"
   fi
}

function build_iso() {

    error_no-archiso

    echo "Clearing ${WORKING} directory before beginning..."

    sudo rm -rf ${WORKING}

    echo "Copying ${CONFIG}/archlive to ${PWD}..."

    sudo cp ${CONFIG}/archlive . -r

    sudo mkarchiso -v -w ${WORKING} -o ${OUTPUT} ${SOURCE}
}

function confirm_run() {

    read -r -p "Build complete. Would you like to run the ISO? y/N: "

    if [[ "${REPLY}" = "y" ]]; then
        echo "Running ISO..."

        qemu-system-x86_64 \
        -boot order=d,menu=on,reboot-timeout=5000 \
        -m "size=3072,slots=0,maxmem=$((3072*1024*1024))" \
        -smp 2 \
        -k en-us \
        -name archiso,process=archiso_0 \
        -device virtio-scsi-pci,id=scsi0 \
        -display sdl \
        -vga virtio \
        -audiodev pa,id=snd0 \
        -device ich9-intel-hda \
        -device hda-output,audiodev=snd0 \
        -device virtio-net-pci,romfile=,netdev=net0 -netdev user,id=net0,hostfwd=tcp::60022-:22 \
        -machine type=q35,smm=on,accel=kvm,usb=on,pcspk-audiodev=snd0 \
        -global ICH9-LPC.disable_s3=1 \
        -enable-kvm \
        -serial stdio \
        -no-reboot \
        -cdrom ${OUTPUT}/jovarkos-${todayDate@P}-x86_64.iso
    else
        echo "Exiting..."
    fi
}

function run_iso() {

    qemu-system-x86_64 \
        -boot order=d,menu=on,reboot-timeout=5000 \
        -m "size=3072,slots=0,maxmem=$((3072*1024*1024))" \
        -smp 2 \
        -k en-us \
        -name archiso,process=archiso_0 \
        -device virtio-scsi-pci,id=scsi0 \
        -display sdl \
        -vga virtio \
        -audiodev pa,id=snd0 \
        -device ich9-intel-hda \
        -device hda-output,audiodev=snd0 \
        -device virtio-net-pci,romfile=,netdev=net0 -netdev user,id=net0,hostfwd=tcp::60022-:22 \
        -machine type=q35,smm=on,accel=kvm,usb=on,pcspk-audiodev=snd0 \
        -global ICH9-LPC.disable_s3=1 \
        -enable-kvm \
        -serial stdio \
        -no-reboot \
        -cdrom "${OPTARG}"
}

function profile() {

    cp -r "/usr/share/archiso/configs/${OPTARG}" ${SOURCE}

    echo "Copied profile ${OPTARG} to ${SOURCE}"
}

function version() {

    echo "JovarkOS ISO build script v2022.05.15.r1"
}

function usage() {

cat << USAGE
Usage: ./build_iso.sh [FLAGS] [OPTIONS]
Options:
-b, build                     Clean working directory and build fresh ISO image using defaults from the ${SOURCE}/profiledef.sh file
-r, run <path to iso>         Run ISO image
-p, profile <profile name>    Create new profile using the specified profile name
-h, help                      Print this help message
-v, version                   Get the version of this script

Options for '-p' and 'profile':
Profile - see <https://wiki.archlinux.org/title/Archiso#Prepare_a_custom_profile>
for more information
     - Use either 'releng' (Used in Official Monthly Builds) or 'baseline' (Minimal live configuration) as the profile name.
     - Profiles live in the /usr/share/archiso/configs/ directory.
USAGE

}


while getopts ":br:p:hv" cmdline_option; do
    case "${cmdline_option}" in
        (b)
            build_iso
        ;;
        (r)
            run_iso "${OPTARG}"
        ;;
        (p)
            profile "${OPTARG}"
        ;;
        (h)
            usage
        ;;
        (v)
            version
        ;;
        (:)
            error "Option -${OPTARG} requires an argument."

            exit 1
        ;;
        ('?')
            error "Invalid option: -${OPTARG}"

            exit 1
        ;;
    esac
done
